# =============================================================================
# TradeCat Docker Compose 一键部署
# 用法:
#   1. 复制并编辑配置: cp config/.env.example config/.env && chmod 600 config/.env
#   2. 设置数据库密码: export POSTGRES_PASSWORD=your_strong_password_here
#   3. 启动: docker-compose up -d
#   4. 查看日志: docker-compose logs -f
#   5. 停止: docker-compose down
#
# 安全注意事项:
#   - 生产环境必须修改 POSTGRES_PASSWORD（通过环境变量或 .env 文件）
#   - 数据库端口默认只绑定 127.0.0.1，不对外暴露
#   - config/.env 必须设置 chmod 600 权限
# =============================================================================

version: '3.8'

services:
  # ===========================================================================
  # TimescaleDB 数据库（预装扩展 + 自动初始化 schema）
  # ===========================================================================
  timescaledb:
    image: timescale/timescaledb:latest-pg16
    container_name: tradecat-db
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-postgres}
      # 安全警告: 生产环境必须通过环境变量设置强密码
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-tradecat_change_me_in_production}
      POSTGRES_DB: market_data
    # 安全: 只绑定本地回环，不对外暴露
    ports:
      - "127.0.0.1:5433:5432"
    volumes:
      # 数据持久化
      - timescaledb_data:/var/lib/postgresql/data
      # 初始化脚本（按文件名顺序执行，只读挂载）
      - ./timescaledb/001_init.sql:/docker-entrypoint-initdb.d/001_init.sql:ro
      - ./timescaledb/002_functions.sql:/docker-entrypoint-initdb.d/002_functions.sql:ro
      - ./timescaledb/003_continuous_aggregates.sql:/docker-entrypoint-initdb.d/003_continuous_aggregates.sql:ro
      - ./timescaledb/004_policies.sql:/docker-entrypoint-initdb.d/004_policies.sql:ro
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-postgres} -d market_data"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    # 资源限制（防止 DoS）
    deploy:
      resources:
        limits:
          memory: 2G
        reservations:
          memory: 512M
    networks:
      - tradecat-network

  # ===========================================================================
  # TradeCat 主服务（data + trading + telegram）
  # ===========================================================================
  tradecat:
    build:
      context: ..
      dockerfile: docker/Dockerfile
    container_name: tradecat-app
    restart: unless-stopped
    depends_on:
      timescaledb:
        condition: service_healthy
    env_file:
      - ../config/.env
    environment:
      # 覆盖数据库连接为容器内网络（使用环境变量密码）
      DATABASE_URL: postgresql://${POSTGRES_USER:-postgres}:${POSTGRES_PASSWORD:-tradecat_change_me_in_production}@timescaledb:5432/market_data
      # 确保 PYTHONPATH 包含 libs
      PYTHONPATH: /app:/app/libs
    volumes:
      # 配置文件（只读挂载，包含 BOT_TOKEN 等敏感信息）
      - ../config/.env:/app/config/.env:ro
      # SQLite 数据持久化
      - sqlite_data:/app/libs/database/services/telegram-service
      # 日志持久化（分离目录避免冲突）
      - logs_data:/app/logs
    # 健康检查：验证所有 3 个服务进程存活
    healthcheck:
      test: ["CMD-SHELL", "pgrep -f 'python.*src' | wc -l | grep -qE '^[3-9]'"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 120s
    # 资源限制
    deploy:
      resources:
        limits:
          memory: 4G
        reservations:
          memory: 1G
    # 安全: 以非 root 用户运行
    user: "1000:1000"
    networks:
      - tradecat-network
    # 默认启动所有服务
    command: ["all"]

  # ===========================================================================
  # 可选：独立启动各服务（按需取消注释）
  # ===========================================================================
  
  # data-service:
  #   build:
  #     context: ..
  #     dockerfile: docker/Dockerfile
  #   container_name: tradecat-data
  #   restart: unless-stopped
  #   depends_on:
  #     timescaledb:
  #       condition: service_healthy
  #   env_file:
  #     - ../config/.env
  #   environment:
  #     DATABASE_URL: postgresql://postgres:postgres@timescaledb:5432/market_data
  #   networks:
  #     - tradecat-network
  #   command: ["data"]

  # trading-service:
  #   build:
  #     context: ..
  #     dockerfile: docker/Dockerfile
  #   container_name: tradecat-trading
  #   restart: unless-stopped
  #   depends_on:
  #     timescaledb:
  #       condition: service_healthy
  #   env_file:
  #     - ../config/.env
  #   environment:
  #     DATABASE_URL: postgresql://postgres:postgres@timescaledb:5432/market_data
  #   volumes:
  #     - sqlite_data:/app/libs/database/services/telegram-service
  #   networks:
  #     - tradecat-network
  #   command: ["trading"]

  # telegram-service:
  #   build:
  #     context: ..
  #     dockerfile: docker/Dockerfile
  #   container_name: tradecat-telegram
  #   restart: unless-stopped
  #   depends_on:
  #     - trading-service
  #   env_file:
  #     - ../config/.env
  #   volumes:
  #     - sqlite_data:/app/libs/database/services/telegram-service
  #   networks:
  #     - tradecat-network
  #   command: ["telegram"]

networks:
  tradecat-network:
    driver: bridge

volumes:
  timescaledb_data:
    driver: local
  sqlite_data:
    driver: local
  logs_data:
    driver: local
