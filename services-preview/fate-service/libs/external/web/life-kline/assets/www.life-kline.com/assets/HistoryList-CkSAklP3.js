import{j as e}from"./index-BxBezyHd.js";import{r as h}from"./recharts-DuwrOd3P.js";import{a0 as H,a1 as w,a2 as v,a3 as k,U as A,i as D,C as L}from"./lucide-BZ5mTEZ-.js";import"./lunar-BPioIzsr.js";const y="lifekline_history",O=10,o=()=>{try{const s=localStorage.getItem(y);return s?JSON.parse(s):[]}catch{return[]}},P=s=>{try{const n=o(),a={id:`local_${Date.now()}`,createdAt:new Date().toISOString(),...s},r=[a,...n].slice(0,O);return localStorage.setItem(y,JSON.stringify(r)),a}catch(n){return console.error("保存历史失败:",n),null}},R=()=>{try{localStorage.removeItem(y)}catch(s){console.error("清除历史失败:",s)}},Y=({onSelect:s,isLoggedIn:n})=>{const[a,r]=h.useState([]),[g,p]=h.useState(!1),[f,b]=h.useState(!0),j=async()=>{p(!0);try{if(n){const t=await fetch("/api/history",{credentials:"include"});if(t.ok){const c=(await t.json()).items||[],i=[];for(const u of c.slice(0,10))try{const m=await fetch(`/api/history/${u.id}`,{credentials:"include"});if(m.ok){const N=await m.json();N.item&&i.push(N.item)}}catch{}const d=o(),x=[...i,...d].sort((u,m)=>new Date(m.createdAt).getTime()-new Date(u.createdAt).getTime()).slice(0,20);r(x)}else r(o())}else r(o())}catch{r(o())}finally{p(!1)}};h.useEffect(()=>{j()},[n]);const S=()=>{confirm("确定要清除所有历史记录吗？")&&(R(),r([]))},C=t=>new Date(t).toLocaleDateString("zh-CN",{month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"});return a.length===0&&!g?null:e.jsxs("div",{className:"w-full max-w-md bg-white rounded-2xl shadow-lg border border-gray-100 overflow-hidden",children:[e.jsxs("button",{onClick:()=>b(!f),className:"w-full px-6 py-4 flex items-center justify-between bg-gradient-to-r from-amber-50 to-orange-50 hover:from-amber-100 hover:to-orange-100 transition-colors",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"bg-amber-500 text-white p-2 rounded-lg",children:e.jsx(H,{className:"w-5 h-5"})}),e.jsxs("div",{className:"text-left",children:[e.jsx("h3",{className:"font-bold text-gray-800",children:"测算历史"}),e.jsxs("p",{className:"text-xs text-gray-500",children:[a.length," 条记录 · 点击查看"]})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[g&&e.jsx(w,{className:"w-4 h-4 text-gray-400 animate-spin"}),e.jsx(v,{className:`w-5 h-5 text-gray-400 transition-transform ${f?"rotate-90":""}`})]})]}),f&&e.jsxs("div",{className:"animate-fade-in",children:[e.jsxs("div",{className:"px-4 py-2 bg-gray-50 border-b border-gray-100 flex justify-between items-center",children:[e.jsxs("button",{onClick:j,className:"text-xs text-gray-500 hover:text-gray-700 flex items-center gap-1",children:[e.jsx(w,{className:"w-3 h-3"}),"刷新"]}),e.jsxs("button",{onClick:S,className:"text-xs text-red-500 hover:text-red-700 flex items-center gap-1",children:[e.jsx(k,{className:"w-3 h-3"}),"清空"]})]}),e.jsx("div",{className:"max-h-80 overflow-y-auto divide-y divide-gray-100",children:a.map(t=>{var l,c,i,d,x;return e.jsxs("button",{onClick:()=>s(t.result,t.input),className:"w-full px-4 py-3 hover:bg-gray-50 transition-colors text-left flex items-center gap-3 group",children:[e.jsx("div",{className:"flex-shrink-0 w-10 h-10 bg-gradient-to-br from-indigo-100 to-purple-100 rounded-lg flex items-center justify-center",children:e.jsx(A,{className:"w-5 h-5 text-indigo-600"})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"font-bold text-gray-800 truncate",children:((l=t.input)==null?void 0:l.name)||"匿名用户"}),e.jsxs("span",{className:"text-xs text-gray-400 flex items-center gap-1",children:[e.jsx(D,{className:"w-3 h-3"}),C(t.createdAt)]})]}),e.jsxs("div",{className:"text-xs text-gray-500 mt-0.5 flex items-center gap-2",children:[e.jsxs("span",{children:[(c=t.input)==null?void 0:c.yearPillar," ",(i=t.input)==null?void 0:i.monthPillar," ",(d=t.input)==null?void 0:d.dayPillar," ",(x=t.input)==null?void 0:x.hourPillar]}),t.cost>0&&e.jsxs("span",{className:"flex items-center gap-1 text-amber-600",children:[e.jsx(L,{className:"w-3 h-3"}),t.cost,"点"]})]})]}),e.jsx(v,{className:"w-4 h-4 text-gray-300 group-hover:text-indigo-500 transition-colors"})]},t.id)})}),a.length===0&&!g&&e.jsx("div",{className:"px-4 py-8 text-center text-gray-400 text-sm",children:"暂无历史记录"})]})]})};export{Y as default,P as saveLocalHistory};
