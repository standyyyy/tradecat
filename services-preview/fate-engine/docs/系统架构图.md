================================================================================
                    FATE-ENGINE TELEGRAM-SERVICE 系统架构图
                         System Architecture (ASCII)
================================================================================
                              生成时间: 2025-12-16
================================================================================


┌─────────────────────────────────────────────────────────────────────────────┐
│                           1. 整体系统架构                                    │
└─────────────────────────────────────────────────────────────────────────────┘

                              ┌─────────────────┐
                              │   Telegram API  │
                              │   (云端服务)     │
                              └────────┬────────┘
                                       │
                                       │ HTTPS (Polling)
                                       │
    ┌──────────────────────────────────┼──────────────────────────────────┐
    │                                  │                                  │
    │  ┌───────────────────────────────┴───────────────────────────────┐  │
    │  │                      start.py (启动入口)                       │  │
    │  │                                                               │  │
    │  │   python start.py bot    →  启动 Telegram Bot                 │  │
    │  │   python start.py api    →  启动 FastAPI 服务                 │  │
    │  │   python start.py both   →  同时启动两者                      │  │
    │  └───────────────────────────────┬───────────────────────────────┘  │
    │                                  │                                  │
    │          ┌───────────────────────┼───────────────────────┐          │
    │          │                       │                       │          │
    │          ▼                       │                       ▼          │
    │  ┌───────────────┐               │               ┌───────────────┐  │
    │  │   bot.py      │               │               │   main.py     │  │
    │  │               │               │               │   (FastAPI)   │  │
    │  │ Telegram Bot  │               │               │               │  │
    │  │ 入口          │               │               │  REST API     │  │
    │  │               │               │               │  :8001        │  │
    │  │ ┌───────────┐ │               │               │               │  │
    │  │ │run_with_  │ │               │               │ /health       │  │
    │  │ │retry()    │ │               │               │ /api/v1/bazi/ │  │
    │  │ │自愈机制   │ │               │               │ /api/v1/user/ │  │
    │  │ └───────────┘ │               │               │               │  │
    │  └───────┬───────┘               │               └───────┬───────┘  │
    │          │                       │                       │          │
    │          └───────────────────────┼───────────────────────┘          │
    │                                  │                                  │
    │                                  ▼                                  │
    │  ┌───────────────────────────────────────────────────────────────┐  │
    │  │                    bazi_calculator.py                         │  │
    │  │                      (核心计算引擎)                            │  │
    │  │                                                               │  │
    │  │   ┌─────────────────────────────────────────────────────┐     │  │
    │  │   │              BaziCalculator 类                       │     │  │
    │  │   │                                                     │     │  │
    │  │   │  输入: birth_dt, gender, longitude                  │     │  │
    │  │   │  输出: 66字段完整八字数据 (JSON)                     │     │  │
    │  │   │                                                     │     │  │
    │  │   │  核心方法:                                          │     │  │
    │  │   │  - calculate()          主计算入口                  │     │  │
    │  │   │  - _calc_four_pillars() 四柱干支                    │     │  │
    │  │   │  - _calc_spirits()      21种神煞                    │     │  │
    │  │   │  - _calc_geju()         10种格局                    │     │  │
    │  │   │  - _calc_major_fortune() 大运排列                   │     │  │
    │  │   └─────────────────────────────────────────────────────┘     │  │
    │  └───────────────────────────────┬───────────────────────────────┘  │
    │                                  │                                  │
    │          ┌───────────────────────┼───────────────────────┐          │
    │          │                       │                       │          │
    │          ▼                       ▼                       ▼          │
    │  ┌───────────────┐       ┌───────────────┐       ┌───────────────┐  │
    │  │report_generator│       │  location.py  │       │   db_v2.py    │  │
    │  │               │       │               │       │               │  │
    │  │ 报告生成      │       │ 地点匹配      │       │ SQLite 封装   │  │
    │  │               │       │               │       │               │  │
    │  │ - 常规版TXT   │       │ - 模糊搜索    │       │ - save_record │  │
    │  │ - AI分析版    │       │ - 3199条数据  │       │ - get_record  │  │
    │  │ - 隐藏部分    │       │ - 经纬度查询  │       │ - 用户记录    │  │
    │  │   模块输出    │       │               │       │               │  │
    │  └───────────────┘       └───────────────┘       └───────────────┘  │
    │                                                                     │
    │  telegram-service/                                                  │
    └─────────────────────────────────────────────────────────────────────┘


┌─────────────────────────────────────────────────────────────────────────────┐
│                          2. 模块依赖关系图                                   │
└─────────────────────────────────────────────────────────────────────────────┘

                            ┌─────────────────────┐
                            │     start.py        │
                            │     (启动入口)       │
                            └──────────┬──────────┘
                                       │
                   ┌───────────────────┼───────────────────┐
                   │                   │                   │
                   ▼                   │                   ▼
          ┌────────────────┐           │          ┌────────────────┐
          │    bot.py      │           │          │    main.py     │
          │  (Telegram)    │           │          │   (FastAPI)    │
          └───────┬────────┘           │          └───────┬────────┘
                  │                    │                  │
                  │    ┌───────────────┴───────────────┐  │
                  │    │                               │  │
                  │    ▼                               │  │
                  │  ┌─────────────────────────────────┴──┴─┐
                  │  │         bazi_calculator.py           │
                  │  │           (核心计算)                  │
                  │  └──────────────────┬───────────────────┘
                  │                     │
                  │     ┌───────────────┼───────────────┐
                  │     │               │               │
                  │     ▼               ▼               ▼
                  │  ┌──────┐     ┌──────────┐    ┌──────────┐
                  │  │lunar │     │ 扩展模块  │    │ 传统模块  │
                  │  │python│     │ (8个)    │    │ (8个)    │
                  │  └──────┘     └──────────┘    └──────────┘
                  │
          ┌───────┴───────┬───────────────┐
          │               │               │
          ▼               ▼               ▼
    ┌──────────┐   ┌──────────┐   ┌──────────┐
    │report_   │   │location  │   │  db_v2   │
    │generator │   │.py       │   │  .py     │
    └──────────┘   └──────────┘   └──────────┘
          │               │               │
          ▼               ▼               ▼
    ┌──────────┐   ┌──────────┐   ┌──────────┐
    │output/   │   │china_    │   │bazi.db   │
    │txt/      │   │coords.csv│   │(SQLite)  │
    └──────────┘   └──────────┘   └──────────┘


┌─────────────────────────────────────────────────────────────────────────────┐
│                          3. 目录结构详图                                     │
└─────────────────────────────────────────────────────────────────────────────┘

fate-engine/
│
├── services/
│   └── telegram-service/                    ← 生产运行的唯一服务
│       │
│       ├── start.py                         ← 统一启动入口
│       ├── requirements.txt                 ← Python 依赖
│       │
│       ├── src/                             ← 源代码目录
│       │   │
│       │   ├── bot.py                       ← Telegram Bot 主程序
│       │   │   ├── run_with_retry()         │ 自愈启动
│       │   │   ├── main()                   │ 应用构建
│       │   │   ├── health_check()           │ 健康检查 (60s)
│       │   │   ├── start()                  │ /start 命令
│       │   │   ├── handle_input()           │ 输入处理
│       │   │   ├── handle_confirm_callback()│ 确认回调
│       │   │   ├── _calc_and_save_report()  │ 计算+保存
│       │   │   ├── _send_with_retry()       │ 发送重试
│       │   │   └── _send_media_group_with_retry() │ 媒体组重试
│       │   │
│       │   ├── main.py                      ← FastAPI 服务
│       │   │   ├── /health                  │ 健康检查
│       │   │   ├── /api/v1/bazi/calculate   │ 排盘计算
│       │   │   ├── /api/v1/records/{id}     │ 获取记录
│       │   │   ├── /api/v1/user/{id}/records│ 用户记录
│       │   │   └── DELETE /api/v1/records   │ 删除记录
│       │   │
│       │   ├── bazi_calculator.py           ← 核心计算 (76KB)
│       │   │   └── BaziCalculator           │ 66字段计算
│       │   │
│       │   ├── report_generator.py          ← 报告生成 (32KB)
│       │   │   └── generate_full_report()   │ TXT 报告
│       │   │
│       │   ├── location.py                  ← 地点服务
│       │   │   ├── search()                 │ 模糊搜索
│       │   │   ├── get_coords()             │ 获取坐标
│       │   │   └── get()                    │ 快捷获取
│       │   │
│       │   ├── models.py                    ← Pydantic 模型
│       │   │   ├── BaziRequest              │ 请求模型
│       │   │   └── BaziResponse             │ 响应模型
│       │   │
│       │   ├── prompts/                     ← AI 提示词
│       │   │   ├── 完整版.md                │ AI 分析版前置
│       │   │   └── 快速版.md                │ 简化版
│       │   │
│       │   ├── ─────────────────────────────┤ 专业扩展模块 (8个)
│       │   ├── sxwnl_integration.py         │ 寿星万年历
│       │   ├── fortel_ziwei_integration.py  │ 紫微斗数
│       │   ├── mikaboshi_fengshui_integration.py │ 风水罗盘
│       │   ├── astro_integration.py         │ 天文占星
│       │   ├── dantalion_integration.py     │ 现代化八字
│       │   ├── advanced_calendar_integration.py │ 高级历法
│       │   ├── enhanced_yijing_integration.py │ 易经系统
│       │   └── system_optimization.py       │ 系统优化
│       │   │
│       │   ├── ─────────────────────────────┤ 传统功能模块 (8个)
│       │   ├── hehun.py                     │ 合婚算法
│       │   ├── xingming.py                  │ 姓名学
│       │   ├── liuyao.py                    │ 六爻占卜
│       │   ├── meihua.py                    │ 梅花易数
│       │   ├── zeri.py                      │ 择日算法
│       │   ├── qimen.py                     │ 奇门遁甲
│       │   ├── liuren.py                    │ 大六壬
│       │   └── ziwei.py                     │ 紫微斗数
│       │   │
│       │   ├── true_solar_time.py           ← 真太阳时
│       │   └── output_formatter.py          ← 输出格式化
│       │
│       ├── output/                          ← 输出目录
│       │   ├── txt/                         │ TXT 报告
│       │   │   ├── YYYY-MM-DD-HH:MM-地点-姓名-性别.txt
│       │   │   └── ...-ai分析版.txt
│       │   ├── json/                        │ JSON 结果
│       │   ├── jsonl/                       │ JSONL 格式
│       │   └── logs/                        │ 日志目录
│       │       └── bot.log                  │ 轮转日志 (5MB*3)
│       │
│       ├── tests/                           ← 测试目录
│       │   ├── test_calculator.py
│       │   ├── test_xingming.py
│       │   └── test_complete_integration.py
│       │
│       └── scripts/                         ← 工具脚本
│           ├── jsonl_to_txt.py
│           └── generate_complete_report.py
│
├── libs/                                    ← 共享库
│   ├── data/
│   │   └── china_coordinates.csv            ← 3199条地点数据
│   │
│   ├── database/bazi/
│   │   ├── bazi.db                          ← SQLite 数据库
│   │   └── db_v2.py                         ← 数据库封装
│   │
│   └── external/github/                     ← 55个外部命理库 (只读)
│       ├── lunar-python-master/             │ 核心历法 (强制)
│       ├── bazi-1-master/                   │ 五行量化
│       ├── sxwnl-master/                    │ 寿星万年历 (Node.js)
│       ├── iztro-main/                      │ 紫微斗数 (TS)
│       ├── fortel-ziweidoushu-main/         │ 专业紫微
│       ├── mikaboshi-main/                  │ 风水罗盘 (Rust)
│       ├── Chinese-Divination-master/       │ 六爻/梅花/奇门
│       ├── Iching-master/                   │ 易经系统
│       └── ... (更多)
│
├── docs/                                    ← 项目文档
├── backups/gz/                              ← 生产备份
│
├── AGENTS.md                                ← 项目上下文
├── README.md                                ← 项目说明
├── SEQUENCE_DIAGRAM.txt                     ← 序列图 (本文件)
└── SYSTEM_DIAGRAM.txt                       ← 系统图 (本文件)


┌─────────────────────────────────────────────────────────────────────────────┐
│                        4. 数据流向图                                         │
└─────────────────────────────────────────────────────────────────────────────┘

                                用户输入
                                   │
                                   ▼
    ┌──────────────────────────────────────────────────────────────────────┐
    │                         输入解析层                                    │
    │  ┌────────────────────────────────────────────────────────────────┐  │
    │  │  parse_input() - 智能解析                                      │  │
    │  │                                                                │  │
    │  │  支持格式:                                                     │  │
    │  │  - "1990-05-15 14:30 深圳 张三"                                │  │
    │  │  - "1990年5月15日 14点30分 深圳市 张三"                        │  │
    │  │  - "19900515 1430 深圳 张三"                                   │  │
    │  │                                                                │  │
    │  │  输出: date_str, time_str, place, name                         │  │
    │  └────────────────────────────────────────────────────────────────┘  │
    └──────────────────────────────────────────────────────────────────────┘
                                   │
                                   ▼
    ┌──────────────────────────────────────────────────────────────────────┐
    │                         地点验证层                                    │
    │  ┌────────────────────────────────────────────────────────────────┐  │
    │  │  location.py                                                   │  │
    │  │                                                                │  │
    │  │  china_coordinates.csv (3199条)                                │  │
    │  │       │                                                        │  │
    │  │       ▼                                                        │  │
    │  │  ┌─────────────────────────────────────────────────────────┐   │  │
    │  │  │ 模糊匹配算法:                                           │   │  │
    │  │  │ 1. 精确匹配: "深圳" → (114.1, 22.5)                     │   │  │
    │  │  │ 2. 后缀去除: "深圳市" → "深圳" → 匹配                   │   │  │
    │  │  │ 3. 包含匹配: "南山区" in "深圳市南山区" → 匹配          │   │  │
    │  │  │ 4. 未匹配 → 返回 None → 退回主菜单                      │   │  │
    │  │  └─────────────────────────────────────────────────────────┘   │  │
    │  └────────────────────────────────────────────────────────────────┘  │
    └──────────────────────────────────────────────────────────────────────┘
                                   │
                                   ▼
    ┌──────────────────────────────────────────────────────────────────────┐
    │                         时间修正层                                    │
    │  ┌────────────────────────────────────────────────────────────────┐  │
    │  │  calc_true_solar_time()                                        │  │
    │  │                                                                │  │
    │  │  公式: 真太阳时 = 北京时间 + (经度 - 120°) × 4分钟             │  │
    │  │                                                                │  │
    │  │  示例:                                                         │  │
    │  │  - 深圳 (114.1°): 14:30 → 14:30 + (114.1-120)*4 = 14:06       │  │
    │  │  - 成都 (104.1°): 14:30 → 14:30 + (104.1-120)*4 = 13:26       │  │
    │  └────────────────────────────────────────────────────────────────┘  │
    └──────────────────────────────────────────────────────────────────────┘
                                   │
                                   ▼
    ┌──────────────────────────────────────────────────────────────────────┐
    │                         核心计算层                                    │
    │  ┌────────────────────────────────────────────────────────────────┐  │
    │  │  BaziCalculator.calculate()                                    │  │
    │  │                                                                │  │
    │  │  ┌──────────────────────────────────────────────────────────┐  │  │
    │  │  │                    lunar-python                          │  │  │
    │  │  │                                                          │  │  │
    │  │  │  Solar → Lunar → EightChar (八字对象)                    │  │  │
    │  │  └──────────────────────────────────────────────────────────┘  │  │
    │  │                          │                                     │  │
    │  │                          ▼                                     │  │
    │  │  ┌──────────────────────────────────────────────────────────┐  │  │
    │  │  │              66字段计算                                   │  │  │
    │  │  │                                                          │  │  │
    │  │  │  核心25字段:                                             │  │  │
    │  │  │  ├─ fourPillars    (四柱干支+纳音)                       │  │  │
    │  │  │  ├─ hiddenStems    (地支藏干)                            │  │  │
    │  │  │  ├─ tenGods        (十神关系)                            │  │  │
    │  │  │  ├─ fiveElements   (五行统计%)                           │  │  │
    │  │  │  ├─ wuxingState    (旺相休囚死)                          │  │  │
    │  │  │  ├─ twelveGrowth   (十二长生)                            │  │  │
    │  │  │  ├─ specialPalaces (胎元/胎息/命宫/身宫)                  │  │  │
    │  │  │  ├─ voidInfo       (四柱旬空)                            │  │  │
    │  │  │  ├─ spirits        (21种神煞)                            │  │  │
    │  │  │  ├─ dayMaster      (日主强弱)                            │  │  │
    │  │  │  ├─ ganzhiRelations(干支合冲刑害)                        │  │  │
    │  │  │  ├─ majorFortune   (大运)                                │  │  │
    │  │  │  ├─ annualFortune  (流年)                                │  │  │
    │  │  │  ├─ monthlyFortune (流月)                                │  │  │
    │  │  │  ├─ xiaoYun        (小运)                                │  │  │
    │  │  │  ├─ boneWeight     (称骨)                                │  │  │
    │  │  │  ├─ mingGua        (命卦)                                │  │  │
    │  │  │  ├─ birthInfo      (出生信息)                            │  │  │
    │  │  │  ├─ jieqiDetail    (节气详情)                            │  │  │
    │  │  │  ├─ siling         (人元司令)                            │  │  │
    │  │  │  ├─ geju           (10种格局)                            │  │  │
    │  │  │  ├─ yongShen       (调候用神)                            │  │  │
    │  │  │  ├─ jiaoYun        (交运时间)                            │  │  │
    │  │  │  ├─ huangLi        (黄历宜忌)                            │  │  │
    │  │  │  └─ trueSolarTime  (真太阳时)                            │  │  │
    │  │  │                                                          │  │  │
    │  │  │  扩展41字段: (专业扩展+传统功能)                          │  │  │
    │  │  │  ├─ sxwnlCalendar, highPrecisionTime, astronomicalData   │  │  │
    │  │  │  ├─ ziweiChart, starPositions, palaceAnalysis            │  │  │
    │  │  │  ├─ fengshuiCompass, directionAnalysis, nineStars        │  │  │
    │  │  │  ├─ planetPositions, zodiacSigns, aspects, houses        │  │  │
    │  │  │  ├─ modernBazi, typeScriptModel, apiInterface            │  │  │
    │  │  │  ├─ multiCalendar, holidays, festivals                   │  │  │
    │  │  │  ├─ hexagrams, yijingAnalysis, divination                │  │  │
    │  │  │  ├─ marriageCompatibility, baziMatching                  │  │  │
    │  │  │  ├─ nameAnalysis, fiveGrids, strokeAnalysis              │  │  │
    │  │  │  ├─ liuyaoHexagram, meihuaYishu                          │  │  │
    │  │  │  ├─ dateSelection, auspiciousDates                       │  │  │
    │  │  │  ├─ qimenDunjia, liurenDivination                        │  │  │
    │  │  │  └─ performance, caching, optimization                   │  │  │
    │  │  └──────────────────────────────────────────────────────────┘  │  │
    │  └────────────────────────────────────────────────────────────────┘  │
    └──────────────────────────────────────────────────────────────────────┘
                                   │
                                   ▼
    ┌──────────────────────────────────────────────────────────────────────┐
    │                         报告生成层                                    │
    │  ┌────────────────────────────────────────────────────────────────┐  │
    │  │  report_generator.py                                           │  │
    │  │                                                                │  │
    │  │  generate_full_report(result) → TXT 报告                       │  │
    │  │                                                                │  │
    │  │  默认隐藏模块:                                                 │  │
    │  │  - 择日推荐 (dateSelection)                                    │  │
    │  │  - 系统附录 (systemInfo)                                       │  │
    │  │  - 姓名合婚 (nameAnalysis, marriageCompatibility)              │  │
    │  │  - 易经细节 (卦名示例/卦辞库/哲学分析)                         │  │
    │  │                                                                │  │
    │  │  输出格式: Markdown 表格 + 代码块                              │  │
    │  └────────────────────────────────────────────────────────────────┘  │
    └──────────────────────────────────────────────────────────────────────┘
                                   │
                                   ▼
    ┌──────────────────────────────────────────────────────────────────────┐
    │                         输出层                                        │
    │                                                                      │
    │  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐       │
    │  │   常规版 TXT    │  │  AI分析版 TXT   │  │   SQLite DB     │       │
    │  │                 │  │                 │  │                 │       │
    │  │ output/txt/     │  │ output/txt/     │  │ bazi.db         │       │
    │  │ YYYY-MM-DD-     │  │ ...-ai分析版    │  │                 │       │
    │  │ HH:MM-地点-     │  │ .txt            │  │ save_record()   │       │
    │  │ 姓名-性别.txt   │  │                 │  │                 │       │
    │  │                 │  │ = prompts/      │  │                 │       │
    │  │                 │  │   完整版.md     │  │                 │       │
    │  │                 │  │ + 常规版内容    │  │                 │       │
    │  └─────────────────┘  └─────────────────┘  └─────────────────┘       │
    │           │                   │                   │                  │
    │           └───────────────────┼───────────────────┘                  │
    │                               │                                      │
    │                               ▼                                      │
    │                      ┌─────────────────┐                             │
    │                      │  Telegram 发送  │                             │
    │                      │                 │                             │
    │                      │ 1. 说明消息     │                             │
    │                      │    + AI链接     │                             │
    │                      │    + [重新排盘] │                             │
    │                      │                 │                             │
    │                      │ 2. Media Group  │                             │
    │                      │    (2个附件)    │                             │
    │                      └─────────────────┘                             │
    └──────────────────────────────────────────────────────────────────────┘


┌─────────────────────────────────────────────────────────────────────────────┐
│                        5. 外部库依赖图                                       │
└─────────────────────────────────────────────────────────────────────────────┘

                          bazi_calculator.py
                                 │
         ┌───────────────────────┼───────────────────────┐
         │                       │                       │
         ▼                       ▼                       ▼
  ┌─────────────┐        ┌─────────────┐        ┌─────────────┐
  │ lunar-python│        │  扩展模块    │        │  传统模块    │
  │  (核心依赖) │        │             │        │             │
  │             │        │             │        │             │
  │ 100%调用    │        │ 原生算法    │        │ 原生算法    │
  │ 强制依赖    │        │ 失败即报错  │        │ 失败即报错  │
  └─────────────┘        └──────┬──────┘        └──────┬──────┘
                                │                      │
    ┌───────────────────────────┼──────────────────────┼───────────────┐
    │                           │                      │               │
    ▼                           ▼                      ▼               ▼
┌────────┐  ┌────────┐  ┌────────┐  ┌────────┐  ┌────────┐  ┌────────┐
│sxwnl   │  │iztro   │  │mikaboshi│ │bazi-1  │  │Chinese │  │Iching  │
│(Node.js)│  │(TS)    │  │(Rust)  │  │        │  │Divina- │  │        │
│        │  │        │  │        │  │        │  │tion    │  │        │
│寿星    │  │紫微    │  │风水    │  │五行    │  │六爻    │  │易经    │
│万年历  │  │斗数    │  │罗盘    │  │量化    │  │梅花    │  │系统    │
└────────┘  └────────┘  └────────┘  └────────┘  └────────┘  └────────┘

多语言环境支持:
┌─────────────────────────────────────────────────────────────────────────┐
│  Python 3.12.3 (主要)  │  Node.js 22.12.0  │  Rust 1.90.0  │  Go 1.21.6 │
└─────────────────────────────────────────────────────────────────────────┘


┌─────────────────────────────────────────────────────────────────────────────┐
│                        6. 健壮性机制图                                       │
└─────────────────────────────────────────────────────────────────────────────┘

                    ┌─────────────────────────────────────┐
                    │           run_with_retry()          │
                    │              外层自愈               │
                    │                                     │
                    │  while True:                        │
                    │    try:                             │
                    │      main()                         │
                    │    except:                          │
                    │      sleep(retry_delay)             │
                    │      retry_delay *= 2  # 指数退避   │
                    │      retry_delay = min(60, ...)     │
                    └──────────────────┬──────────────────┘
                                       │
                                       ▼
                    ┌─────────────────────────────────────┐
                    │           health_check()            │
                    │            健康检查                 │
                    │                                     │
                    │  每60秒:                            │
                    │    bot.get_me()                     │
                    │    if 失败:                         │
                    │      fail_count++                   │
                    │    if fail_count >= 3:              │
                    │      app.stop()  # 触发外层重启     │
                    └──────────────────┬──────────────────┘
                                       │
                                       ▼
    ┌──────────────────────────────────┴──────────────────────────────────┐
    │                                                                     │
    ▼                                                                     ▼
┌─────────────────────────────┐                   ┌─────────────────────────────┐
│   _send_with_retry()        │                   │ _send_media_group_with_retry│
│                             │                   │                             │
│ 单消息发送重试              │                   │ 媒体组发送重试              │
│                             │                   │                             │
│ max_retries = 4             │                   │ max_retries = 4             │
│ base_delay = 2s             │                   │ 每次重试重新打开文件句柄    │
│ max_delay = 60s             │                   │                             │
│                             │                   │                             │
│ 处理异常:                   │                   │ 处理异常:                   │
│ - RetryAfter → 等待指定时间 │                   │ - RetryAfter                │
│ - NetworkError → 指数退避   │                   │ - NetworkError              │
│ - TimedOut → 指数退避       │                   │ - TimedOut                  │
│                             │                   │                             │
│ on_retry() → 通知用户(仅1次)│                   │ on_retry() → 通知用户       │
└─────────────────────────────┘                   └─────────────────────────────┘


================================================================================
                                  图例说明
================================================================================

  ───────>  数据流向 / 调用关系
  ─ ─ ─ ─>  可选 / 条件流向
  
  ┌───────┐
  │ 模块  │  系统组件 / 模块
  └───────┘
  
  [按钮]    用户交互元素
  
  组件说明:
  - bot.py           : Telegram Bot 主程序，含自愈机制
  - main.py          : FastAPI REST API 服务
  - bazi_calculator  : 66字段八字计算核心
  - report_generator : TXT 报告生成器
  - location.py      : 3199条地点模糊匹配
  - db_v2.py         : SQLite 数据库封装
  - lunar-python     : 核心历法库 (强制依赖)

================================================================================
                              Fate-Engine v1.0
                         专业级八字排盘系统架构文档
================================================================================
