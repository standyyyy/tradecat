================================================================================
                    FATE-ENGINE TELEGRAM-SERVICE 序列图
                         Sequence Diagrams (ASCII)
================================================================================
                              生成时间: 2025-12-16
================================================================================


┌─────────────────────────────────────────────────────────────────────────────┐
│                        1. BOT 启动与自愈流程                                 │
└─────────────────────────────────────────────────────────────────────────────┘

  start.py           run_with_retry()         main()              Telegram API
     │                     │                    │                      │
     │  python start.py bot│                    │                      │
     ├────────────────────>│                    │                      │
     │                     │                    │                      │
     │                     │ while True:        │                      │
     │                     ├───────┐            │                      │
     │                     │       │ try:       │                      │
     │                     │<──────┘            │                      │
     │                     │                    │                      │
     │                     │  启动 Bot          │                      │
     │                     ├───────────────────>│                      │
     │                     │                    │                      │
     │                     │                    │  Application.build() │
     │                     │                    ├─────────────────────>│
     │                     │                    │                      │
     │                     │                    │  set_my_commands()   │
     │                     │                    ├─────────────────────>│
     │                     │                    │<─────────────────────┤
     │                     │                    │                      │
     │                     │                    │  run_polling()       │
     │                     │                    ├─────────────────────>│
     │                     │                    │                      │
     │                     │                    │  ┌──────────────────┐│
     │                     │                    │  │ 每60s健康检查    ││
     │                     │                    │  │ health_check()   ││
     │                     │                    │  │   bot.get_me()   ││
     │                     │                    │  │ 失败3次→退出     ││
     │                     │                    │  └──────────────────┘│
     │                     │                    │                      │
     │                     │  异常退出          │                      │
     │                     │<───────────────────┤                      │
     │                     │                    │                      │
     │                     │ sleep(retry_delay) │                      │
     │                     ├───────┐            │                      │
     │                     │       │ 指数退避   │                      │
     │                     │<──────┘ 5s→10s→20s→40s→60s(max)          │
     │                     │                    │                      │
     │                     │ 重新启动 main()    │                      │
     │                     ├───────────────────>│                      │
     │                     │                    │                      │


┌─────────────────────────────────────────────────────────────────────────────┐
│                     2. 用户排盘完整交互流程                                   │
└─────────────────────────────────────────────────────────────────────────────┘

  User          Telegram        bot.py         location.py    bazi_calculator   report_gen    db_v2
   │               │               │               │               │               │           │
   │  /start       │               │               │               │               │           │
   ├──────────────>│               │               │               │               │           │
   │               │  Update       │               │               │               │           │
   │               ├──────────────>│               │               │               │           │
   │               │               │               │               │               │           │
   │               │               │ start()       │               │               │           │
   │               │               ├───────┐       │               │               │           │
   │               │               │       │ clear user_data       │               │           │
   │               │               │<──────┘ gender="male"         │               │           │
   │               │               │               │               │               │           │
   │               │  主菜单消息   │               │               │               │           │
   │<──────────────┼───────────────┤               │               │               │           │
   │               │  [乾造] [坤造]│               │               │               │           │
   │               │               │               │               │               │           │
   │  点击[坤造]   │               │               │               │               │           │
   ├──────────────>│               │               │               │               │           │
   │               │  CallbackQuery│               │               │               │           │
   │               ├──────────────>│               │               │               │           │
   │               │               │               │               │               │           │
   │               │               │ handle_main_callback()        │               │           │
   │               │               ├───────┐       │               │               │           │
   │               │               │       │ gender="female"       │               │           │
   │               │               │<──────┘       │               │               │           │
   │               │               │               │               │               │           │
   │               │  更新菜单     │               │               │               │           │
   │<──────────────┼───────────────┤               │               │               │           │
   │               │               │               │               │               │           │
   │  输入信息     │               │               │               │               │           │
   │  "1990-05-15  │               │               │               │               │           │
   │   14:30 深圳  │               │               │               │               │           │
   │   张三"       │               │               │               │               │           │
   ├──────────────>│               │               │               │               │           │
   │               │  Message      │               │               │               │           │
   │               ├──────────────>│               │               │               │           │
   │               │               │               │               │               │           │
   │               │               │ handle_input()│               │               │           │
   │               │               ├───────┐       │               │               │           │
   │               │               │       │ parse_input()         │               │           │
   │               │               │       │ 智能解析:             │               │           │
   │               │               │       │ - 日期格式            │               │           │
   │               │               │       │ - 时间格式            │               │           │
   │               │               │       │ - 地点提取            │               │           │
   │               │               │       │ - 姓名提取            │               │           │
   │               │               │<──────┘       │               │               │           │
   │               │               │               │               │               │           │
   │               │               │ get_coords()  │               │               │           │
   │               │               ├──────────────>│               │               │           │
   │               │               │               │               │               │           │
   │               │               │               │ 模糊匹配      │               │           │
   │               │               │               │ china_coordinates.csv         │           │
   │               │               │               │ (3199条)      │               │           │
   │               │               │               │               │               │           │
   │               │               │  (lng, lat)   │               │               │           │
   │               │               │<──────────────┤               │               │           │
   │               │               │               │               │               │           │
   │               │  确认页面     │               │               │               │           │
   │<──────────────┼───────────────┤               │               │               │           │
   │               │  [开始排盘]   │               │               │               │           │
   │               │  [返回修改]   │               │               │               │           │
   │               │               │               │               │               │           │
   │  点击[开始排盘]               │               │               │               │           │
   ├──────────────>│               │               │               │               │           │
   │               │  CallbackQuery│               │               │               │           │
   │               ├──────────────>│               │               │               │           │
   │               │               │               │               │               │           │
   │               │               │ handle_confirm_callback()     │               │           │
   │               │               ├───────┐       │               │               │           │
   │               │               │       │ "⏳ 正在排盘..."      │               │           │
   │               │               │<──────┘       │               │               │           │
   │               │               │               │               │               │           │
   │               │  "⏳ 正在排盘..."             │               │               │           │
   │<──────────────┼───────────────┤               │               │               │           │
   │               │               │               │               │               │           │
   │               │               │ asyncio.to_thread()           │               │           │
   │               │               │ _calc_and_save_report()       │               │           │
   │               │               │ (timeout=60s) │               │               │           │
   │               │               ├───────────────┼──────────────>│               │           │
   │               │               │               │               │               │           │
   │               │               │               │               │ calc_true_solar_time()    │
   │               │               │               │               ├───────┐       │           │
   │               │               │               │               │       │ 经度时差修正     │
   │               │               │               │               │<──────┘       │           │
   │               │               │               │               │               │           │
   │               │               │               │               │ BaziCalculator.calculate()│
   │               │               │               │               ├───────┐       │           │
   │               │               │               │               │       │       │           │
   │               │               │               │               │  ┌────┴────────────────┐  │
   │               │               │               │               │  │ 66字段计算:        │  │
   │               │               │               │               │  │ - fourPillars      │  │
   │               │               │               │               │  │ - hiddenStems      │  │
   │               │               │               │               │  │ - tenGods          │  │
   │               │               │               │               │  │ - fiveElements     │  │
   │               │               │               │               │  │ - spirits (21种)   │  │
   │               │               │               │               │  │ - geju (10种格局)  │  │
   │               │               │               │               │  │ - majorFortune     │  │
   │               │               │               │               │  │ - annualFortune    │  │
   │               │               │               │               │  │ - boneWeight       │  │
   │               │               │               │               │  │ - mingGua          │  │
   │               │               │               │               │  │ - ... (更多)       │  │
   │               │               │               │               │  └───────────────────┘   │
   │               │               │               │               │<──────┘       │           │
   │               │               │               │               │               │           │
   │               │               │               │  result (JSON)│               │           │
   │               │               │<──────────────┼───────────────┤               │           │
   │               │               │               │               │               │           │
   │               │               │ generate_full_report()        │               │           │
   │               │               ├───────────────┼───────────────┼──────────────>│           │
   │               │               │               │               │               │           │
   │               │               │               │               │               │ 生成TXT   │
   │               │               │               │               │               │ (隐藏部分 │
   │               │               │               │               │               │  模块)    │
   │               │               │               │               │               │           │
   │               │               │  report_txt   │               │               │           │
   │               │               │<──────────────┼───────────────┼───────────────┤           │
   │               │               │               │               │               │           │
   │               │               │ 写入文件:     │               │               │           │
   │               │               │ output/txt/   │               │               │           │
   │               │               │ ├─ 常规版.txt │               │               │           │
   │               │               │ └─ -ai分析版.txt (拼接prompts/完整版.md)      │           │
   │               │               │               │               │               │           │
   │               │               │ db.save_record()              │               │           │
   │               │               ├───────────────┼───────────────┼───────────────┼──────────>│
   │               │               │               │               │               │           │
   │               │               │               │               │               │  SQLite   │
   │               │               │               │               │               │  bazi.db  │
   │               │               │               │               │               │           │
   │               │               │<──────────────┼───────────────┼───────────────┼───────────┤
   │               │               │               │               │               │           │
   │               │  "✅ 排盘完成"│               │               │               │           │
   │<──────────────┼───────────────┤               │               │               │           │
   │               │               │               │               │               │           │
   │               │               │ _send_with_retry()            │               │           │
   │               │               │ 发送说明消息  │               │               │           │
   │               │               ├──────────────>│               │               │           │
   │               │               │               │               │               │           │
   │               │  说明消息     │               │               │               │           │
   │               │  + AI链接     │               │               │               │           │
   │               │  + [重新排盘] │               │               │               │           │
   │<──────────────┼───────────────┤               │               │               │           │
   │               │               │               │               │               │           │
   │               │               │ _send_media_group_with_retry()│               │           │
   │               │               │ 发送2个附件   │               │               │           │
   │               │               ├──────────────>│               │               │           │
   │               │               │               │               │               │           │
   │               │  [常规版.txt] │               │               │               │           │
   │               │  [-ai分析版.txt]              │               │               │           │
   │<──────────────┼───────────────┤               │               │               │           │
   │               │               │               │               │               │           │


┌─────────────────────────────────────────────────────────────────────────────┐
│                      3. 网络重试机制详细流程                                  │
└─────────────────────────────────────────────────────────────────────────────┘

  bot.py              _send_with_retry()           Telegram API
     │                       │                          │
     │  send_fn()            │                          │
     ├──────────────────────>│                          │
     │                       │                          │
     │                       │  for attempt in range(4):│
     │                       ├───────┐                  │
     │                       │       │                  │
     │                       │<──────┘                  │
     │                       │                          │
     │                       │  await send_fn()         │
     │                       ├─────────────────────────>│
     │                       │                          │
     │                       │                          │
     │                       │  ┌─────────────────────┐ │
     │                       │  │ 可能的异常:         │ │
     │                       │  │ - RetryAfter       │ │
     │                       │  │ - NetworkError     │ │
     │                       │  │ - TimedOut         │ │
     │                       │  └─────────────────────┘ │
     │                       │                          │
     │                       │  RetryAfter(30s)         │
     │                       │<─────────────────────────┤
     │                       │                          │
     │                       │  on_retry("限流,等待30s")│
     │                       ├───────┐                  │
     │                       │       │ 通知用户(仅一次)│
     │                       │<──────┘                  │
     │                       │                          │
     │                       │  sleep(min(30, 60))      │
     │                       ├───────┐                  │
     │                       │       │                  │
     │                       │<──────┘                  │
     │                       │                          │
     │                       │  retry attempt 2         │
     │                       ├─────────────────────────>│
     │                       │                          │
     │                       │  NetworkError            │
     │                       │<─────────────────────────┤
     │                       │                          │
     │                       │  sleep(2^attempt)        │
     │                       │  2s → 4s → 8s → 16s      │
     │                       ├───────┐                  │
     │                       │       │ 指数退避        │
     │                       │<──────┘                  │
     │                       │                          │
     │                       │  retry attempt 3         │
     │                       ├─────────────────────────>│
     │                       │                          │
     │                       │  Success                 │
     │                       │<─────────────────────────┤
     │                       │                          │
     │  return result        │                          │
     │<──────────────────────┤                          │
     │                       │                          │


┌─────────────────────────────────────────────────────────────────────────────┐
│                       4. FastAPI 服务调用流程                                │
└─────────────────────────────────────────────────────────────────────────────┘

  Client              main.py (FastAPI)        bazi_calculator        db_v2
     │                       │                       │                  │
     │  POST /api/v1/bazi/calculate                  │                  │
     │  {                    │                       │                  │
     │    "name": "张三",    │                       │                  │
     │    "gender": "male",  │                       │                  │
     │    "birthDate": "...",│                       │                  │
     │    "birthTime": "...",│                       │                  │
     │    "birthPlace": {...}│                       │                  │
     │  }                    │                       │                  │
     ├──────────────────────>│                       │                  │
     │                       │                       │                  │
     │                       │  Pydantic 验证        │                  │
     │                       │  BaziRequest          │                  │
     │                       ├───────┐               │                  │
     │                       │       │               │                  │
     │                       │<──────┘               │                  │
     │                       │                       │                  │
     │                       │  calc_true_solar_time()                  │
     │                       ├──────────────────────>│                  │
     │                       │                       │                  │
     │                       │  true_solar_dt        │                  │
     │                       │<──────────────────────┤                  │
     │                       │                       │                  │
     │                       │  BaziCalculator()     │                  │
     │                       │  .calculate()         │                  │
     │                       ├──────────────────────>│                  │
     │                       │                       │                  │
     │                       │                       │ 66字段计算       │
     │                       │                       ├───────┐         │
     │                       │                       │       │         │
     │                       │                       │<──────┘         │
     │                       │                       │                  │
     │                       │  result               │                  │
     │                       │<──────────────────────┤                  │
     │                       │                       │                  │
     │                       │  构建 BaziResponse    │                  │
     │                       ├───────┐               │                  │
     │                       │       │ BaziData      │                  │
     │                       │       │ TimeInfo      │                  │
     │                       │       │ Meta          │                  │
     │                       │<──────┘               │                  │
     │                       │                       │                  │
     │                       │  db.save_record()     │                  │
     │                       ├──────────────────────────────────────────>│
     │                       │                       │                  │
     │                       │  record_id            │                  │
     │                       │<──────────────────────────────────────────┤
     │                       │                       │                  │
     │  BaziResponse         │                       │                  │
     │  {                    │                       │                  │
     │    "success": true,   │                       │                  │
     │    "data": {...},     │                       │                  │
     │    "meta": {...}      │                       │                  │
     │  }                    │                       │                  │
     │<──────────────────────┤                       │                  │
     │                       │                       │                  │


┌─────────────────────────────────────────────────────────────────────────────┐
│                      5. 八字计算核心流程                                     │
└─────────────────────────────────────────────────────────────────────────────┘

  BaziCalculator                lunar-python              扩展模块
        │                            │                       │
        │  __init__(birth_dt, gender, longitude)             │
        ├───────┐                    │                       │
        │       │ 初始化参数         │                       │
        │<──────┘                    │                       │
        │                            │                       │
        │  calculate()               │                       │
        ├───────┐                    │                       │
        │       │                    │                       │
        │       │  Solar.fromYmdHms()│                       │
        │       ├───────────────────>│                       │
        │       │                    │                       │
        │       │  solar.getLunar()  │                       │
        │       ├───────────────────>│                       │
        │       │                    │                       │
        │       │  lunar.getEightChar()                      │
        │       ├───────────────────>│                       │
        │       │                    │                       │
        │       │  bazi (八字对象)   │                       │
        │       │<───────────────────┤                       │
        │       │                    │                       │
        │       │  ┌─────────────────────────────────────┐   │
        │       │  │ 核心计算 (25字段):                  │   │
        │       │  │                                     │   │
        │       │  │ 1. _calc_four_pillars()            │   │
        │       │  │    - 年月日时干支                   │   │
        │       │  │    - 纳音五行                       │   │
        │       │  │                                     │   │
        │       │  │ 2. _calc_hidden_stems()            │   │
        │       │  │    - 地支藏干                       │   │
        │       │  │                                     │   │
        │       │  │ 3. _calc_ten_gods()                │   │
        │       │  │    - 十神关系                       │   │
        │       │  │                                     │   │
        │       │  │ 4. _calc_five_elements()           │   │
        │       │  │    - 五行统计百分比                 │   │
        │       │  │                                     │   │
        │       │  │ 5. _calc_day_master()              │   │
        │       │  │    - 日主强弱分析                   │   │
        │       │  │                                     │   │
        │       │  │ 6. _calc_spirits()                 │   │
        │       │  │    - 21种神煞                       │   │
        │       │  │                                     │   │
        │       │  │ 7. _calc_major_fortune()           │   │
        │       │  │    - 大运排列                       │   │
        │       │  │                                     │   │
        │       │  │ 8. _calc_annual_fortune()          │   │
        │       │  │    - 流年分析                       │   │
        │       │  │                                     │   │
        │       │  │ 9. _calc_geju()                    │   │
        │       │  │    - 10种格局判定                   │   │
        │       │  │                                     │   │
        │       │  │ 10. _calc_yong_shen()              │   │
        │       │  │     - 调候用神                      │   │
        │       │  │                                     │   │
        │       │  │ ... (更多核心计算)                  │   │
        │       │  └─────────────────────────────────────┘   │
        │       │                    │                       │
        │       │  扩展模块调用      │                       │
        │       ├────────────────────┼──────────────────────>│
        │       │                    │                       │
        │       │                    │  ┌──────────────────┐ │
        │       │                    │  │ 8个专业扩展:     │ │
        │       │                    │  │ - sxwnl          │ │
        │       │                    │  │ - fortel_ziwei   │ │
        │       │                    │  │ - mikaboshi      │ │
        │       │                    │  │ - astro          │ │
        │       │                    │  │ - calendar       │ │
        │       │                    │  │ - yijing         │ │
        │       │                    │  │ - optimization   │ │
        │       │                    │  │ - dantalion      │ │
        │       │                    │  └──────────────────┘ │
        │       │                    │                       │
        │       │                    │  ┌──────────────────┐ │
        │       │                    │  │ 8个传统功能:     │ │
        │       │                    │  │ - hehun (合婚)   │ │
        │       │                    │  │ - xingming (姓名)│ │
        │       │                    │  │ - liuyao (六爻)  │ │
        │       │                    │  │ - meihua (梅花)  │ │
        │       │                    │  │ - zeri (择日)    │ │
        │       │                    │  │ - qimen (奇门)   │ │
        │       │                    │  │ - liuren (六壬)  │ │
        │       │                    │  │ - ziwei (紫微)   │ │
        │       │                    │  └──────────────────┘ │
        │       │                    │                       │
        │       │  扩展结果          │                       │
        │       │<───────────────────┼───────────────────────┤
        │       │                    │                       │
        │<──────┘                    │                       │
        │                            │                       │
        │  return result (66字段)    │                       │
        │                            │                       │


================================================================================
                                  图例说明
================================================================================

  ─────>  同步调用
  ─ ─ ─>  异步调用
  ├───┐   循环/条件开始
  │   │
  │<──┘   循环/条件结束
  
  [按钮]  Telegram 内联键盘按钮
  
  组件缩写:
  - bot.py          : Telegram Bot 主入口
  - main.py         : FastAPI 服务入口
  - bazi_calculator : 八字计算核心
  - report_gen      : 报告生成器
  - db_v2           : SQLite 数据库封装
  - location.py     : 地点模糊匹配

================================================================================
